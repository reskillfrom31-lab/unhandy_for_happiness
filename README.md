# Unhandy for Happiness

SNSや動画サイトへの依存に悩む方を支援するWebアプリケーション

[![Ruby](https://img.shields.io/badge/Ruby-3.2.0-red.svg)](https://www.ruby-lang.org/)
[![Rails](https://img.shields.io/badge/Rails-7.1.5-red.svg)](https://rubyonrails.org/)
[![MySQL](https://img.shields.io/badge/MySQL-8.0-blue.svg)](https://www.mysql.com/)
[![Docker](https://img.shields.io/badge/Docker-latest-blue.svg)](https://www.docker.com/)

---

## 📖 目次

- [デモ](#デモ)
- [概要](#概要)
- [ターゲット層](#ターゲット層)
- [主な機能](#主な機能)
- [使用技術](#使用技術)
- [工夫した点](#工夫した点)
- [今後の改善点](#今後の改善点)
- [ローカル環境での起動方法](#ローカル環境での起動方法)
- [デプロイ方法](#デプロイ方法)
- [運用方法](#運用方法)
- [トラブルシューティング](#トラブルシューティング)

---

## 🌐 デモ

**デモURL:** [http://52.68.23.100:3000](http://52.68.23.100:3000)

> **注意:** 現在HTTP接続です。HTTPS化は今後実装予定です。

---

## 📌 概要

**Unhandy for Happiness**は、SNSや動画投稿サイトへの依存に悩むユーザーを支援するWebアプリケーションです。

ユーザーが自ら質問文を作成し、YouTubeやInstagramにアクセスする前に自己内省を促すことで、自己肯定感を保ちながら学習に集中できる環境を提供します。

### 開発目的

- SNSや動画投稿サイトへの依存に悩むユーザーを支援する
- ユーザーが自ら質問文を作ることで、自らを律し、自己肯定感を高めながら学習に取り組めるようにする
- 他人の主観や自己の劣等感に流されずに、自己管理能力を育成する

---

## 🎯 ターゲット層

- 勉強したくても、ついついSNSや動画投稿サイトを見て時間を浪費してしまう人
- 発達障害など、生来特性により長時間学習したり集中することが難しい人
- SNSや動画投稿サイトをつい長時間見てしまい、不眠や生活リズムをコントロールできない人
- 学習に集中できる時間や環境をどうすれば確保できるか分からずに悩んでいる人
- 学校や塾、人間関係、会社等、周囲から抑圧が無いと頑張れない、無気力で受動的な自分を変えられずに悩んでいる人

---

## ✨ 主な機能

### 1. ユーザー認証機能（Devise）
- 新規登録・ログイン・ログアウト
- パスワードリセット機能（メール送信は今後実装予定）

### 2. 質問管理機能
- 最低5つの質問を作成（初期設定）
- 最大20項目まで質問を追加可能
- 質問の編集・削除（5つ未満には減らせない）
- 3種類の質問タイプ：
  - 自由記述
  - はい/いいえ
  - 数値入力

### 3. Chrome拡張機能連携
- YouTubeやInstagramへのアクセスを自動的にリダイレクト
- ユーザーが作成した質問に回答するまでアクセスを制限
- 全ての質問に回答後、10秒後にアクセス可能

### 4. アクセス制御
- ブラウザ拡張機能（unhandy_redirector）により、特定のサイトへのアクセスを管理
- 質問への回答を完了するまで、対象サイトへのアクセスをブロック

---

## 🛠️ 使用技術

### バックエンド
- **Ruby** 3.2.0
- **Ruby on Rails** 7.1.5.2
- **MySQL** 8.0
- **Devise** - ユーザー認証

### フロントエンド
- **Stimulus.js** - JavaScriptフレームワーク
- **Turbo** - SPA風の高速ページ遷移
- **Importmap** - JavaScript管理

### インフラ・デプロイ
- **Docker** - コンテナ化
- **AWS EC2** - Ubuntu 24.04 LTS
- **Puma** - Webサーバー

### ブラウザ拡張機能
- **Chrome Extension Manifest V3**
- **WebNavigation API**

### 開発ツール
- **Git / GitHub** - バージョン管理
- **GitHub Desktop** - Git操作
- **WSL2** - Windows開発環境

---

## 💡 工夫した点

### 1. Dockerによるコンテナ化
- 開発環境と本番環境の差異を最小化
- 環境構築の手間を削減
- 再現性の高いデプロイを実現

### 2. セキュリティの基本を徹底
- APIキーや秘密情報を環境変数化（`.env`ファイルは`.gitignore`で除外）
- データベースのパスワードを環境変数で管理
- `SECRET_KEY_BASE`をコマンドラインで生成・管理

### 3. 自動起動設定
- `docker run --restart always`により、EC2再起動時も自動的にアプリケーションが起動
- 運用の手間を削減

### 4. Chrome拡張機能との連携
- Manifest V3に対応した最新の実装
- WebNavigation APIを使用した確実なリダイレクト処理
- 無限ループを防ぐためのパラメータチェック

### 5. ユーザー体験の向上
- 自己内省を促す質問システム
- 段階的なアクセス許可（5つの質問 → 10秒待機 → アクセス許可）
- 質問のカスタマイズ性（3種類の質問タイプ）
- 画面の役割分離（一覧・管理・追加を明確に区別）

### 6. Dockerネットワーク設定の理解
- ホストネットワーク（`--network host`）の採用
- MySQLへの接続を確保しつつ、シンプルな構成を維持
- 今後の改善方向（Docker Compose化）を明確に設定

---

## 📚 デプロイで学んだこと

このプロジェクトでは、初めてのAWS EC2へのデプロイに挑戦しました。その過程で多くのエラーに遭遇しましたが、それぞれが貴重な学びとなりました。

### デプロイ実績

| 回数 | 日付 | 時間 | 主なエラー/問題 |
|------|------|------|----------------|
| **1回目** | 2025-12-19 | 約8時間 | MySQL認証、権限、SECRET_KEY_BASE等（5つのエラー） |
| **2回目** | 2025-12-28 | 約2時間 | コンテナ内ファイル同期（3つの問題） |
| **3回目** | 2026-01-13 | 約1.5時間 | Dockerネットワーク設定（1つの問題） |

**改善率**: 初回比で約5.3倍の効率化

### 遭遇した主なエラーと解決

#### 1. SSH接続タイムアウト
**問題**: Wi-Fi変更により自分のIPアドレスが変わり、EC2に接続できなくなった  
**学び**: 動的IPアドレスの理解、AWSセキュリティグループの設定方法

#### 2. ファイル実行権限エラー
**問題**: `bin/docker-entrypoint`に実行権限がなくコンテナが起動しない  
**学び**: Linuxのパーミッション（chmod）、Dockerイメージはビルド時の状態を含む

#### 3. SECRET_KEY_BASE不足
**問題**: 本番環境でRailsの秘密鍵が設定されていない  
**学び**: 開発環境と本番環境の設定の違い、環境変数での機密情報管理

#### 4. データベース認証エラー（最も難解）
**問題**: MySQL 8.0の認証方式とRailsの互換性問題  
**学び**: バージョン間の互換性の重要性、`mysql_native_password`と`caching_sha2_password`の違い

#### 5. パスワードポリシー違反
**問題**: 単純なパスワードがMySQLのセキュリティポリシーで拒否された  
**学び**: 本番環境でのセキュリティ要件、強固なパスワードの必要性

#### 6. Dockerネットワーク設定エラー（3回目デプロイ）
**問題**: コンテナからホスト側のMySQLに接続できない  
**学び**: Dockerの隔離設計、`--network host`の使用理由、ポートマッピングとの違い

### 習得したスキル

**技術面**
- Dockerの実践的な使用（イメージビルド、コンテナ管理、環境変数、ネットワーク設定）
- Linuxサーバー管理（SSH接続、ファイル権限、systemctl）
- MySQLのユーザー管理と認証方式の理解
- AWS EC2とセキュリティグループの基本操作

**問題解決面**
- **層別思考**: 問題をネットワーク層・コンテナ層・アプリケーション層・DB層に分けて切り分ける
- **ログの活用**: `docker logs`で必ず原因を確認する習慣
- **「なぜ？」を大切にする**: 動いたからOKではなく、なぜ動いたのか理解する
- **ドキュメント化**: エラーと解決方法を記録し、次回に活かす
- **効率化**: デプロイ時間を8時間から1.5時間に短縮（約5.3倍）

**UX改善・セキュリティ面**
- ユーザー体験を考慮した画面設計（質問管理・追加・公開画面の分離）
- セキュリティテストの実装（マスアサインメント、XSS、SQLインジェクション等）
- 認証・認可のテストコード作成

### 詳細なデプロイストーリー

デプロイの詳細な記録は、`docs/private/DEPLOYMENT_STORY.md`に記載しています。  
面接での技術説明の参考として、以下の内容を含んでいます：

- 各エラーの詳細な原因分析
- 思考プロセスと解決手順
- 学んだ技術的知識
- 今後の改善計画

### 最新の技術的挑戦（2026年1月）

#### UX改善
- 質問管理画面を3つに分離（一覧・管理・追加）
- ルーティング構成の最適化
- ユーザビリティ向上のための画面フロー改善

#### セキュリティ強化
- 包括的なセキュリティテストの実装（32テスト）
- マスアサインメント攻撃対策のテスト
- XSS（クロスサイトスクリプティング）対策のテスト
- SQLインジェクション対策のテスト
- セッション管理のテスト
- バリデーションのテスト

---

## 🚀 今後の改善点

### インフラ（優先度: 高）
- [ ] **EBSボリューム拡張**（8GB → 16GB）- Docker Compose導入の前提条件
- [ ] **MySQLのコンテナ化**（Docker Compose）- セキュリティ向上と業界標準の構成へ
- [ ] **ポートマッピング方式への移行**（`-p 3000:3000`）- `--network host`からの脱却

### セキュリティ（優先度: 中）
- [ ] **HTTPS対応**（Let's EncryptまたはCloudflare）
- [ ] **定期バックアップの自動化**（crontab + S3）
- [ ] メール送信機能の実装（SendGrid または AWS SES）
- [ ] より強固なパスワードポリシー

### 運用効率化（優先度: 中）
- [ ] CI/CDパイプラインの構築（GitHub Actions）
- [ ] 独自ドメインの取得
- [ ] Nginxをリバースプロキシとして導入

### 機能拡張（優先度: 低）
- [ ] 質問の公開・共有機能の強化（ハッシュタグ検索）
- [ ] 統計情報の表示（アクセス履歴、回答履歴）
- [ ] 複数ブラウザ対応（Firefox、Edge）

### コード品質（継続的改善）
- [x] セキュリティテストの実装（マスアサインメント、XSS、SQLインジェクション等）
- [ ] RSpecへの移行（現在はMinitestを使用）
- [ ] システムテストの追加（Capybara）
- [ ] ER図の作成
- [ ] APIドキュメントの整備

### 実装予定（2026年1月18日以降）
1. EBSボリューム拡張
2. Docker Composeでのコンテナ化
3. HTTPS化の検討

---

## 🖥️ ローカル環境での起動方法

### 前提条件
- Ruby 3.2.0
- MySQL 8.0
- Node.js（Importmap使用のため）

### 手順

1. **リポジトリをクローン**
```bash
git clone https://github.com/your-username/unhandy_for_happiness.git  🔧 [要変更: your-usernameを実際のGitHubユーザー名に変更]
cd unhandy_for_happiness
```

2. **依存関係をインストール**
```bash
bundle install
```

3. **データベースの設定**
```bash
# MySQLにログイン
sudo mysql

# データベースとユーザーを作成
CREATE DATABASE unhandy_for_happiness_development;
CREATE USER 'root'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON unhandy_for_happiness_development.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# マイグレーション実行
bin/rails db:migrate
```

4. **サーバーを起動**
```bash
bin/rails server
```

5. **ブラウザでアクセス**
```
http://localhost:3000
```

---

## 🚢 デプロイ方法

### クイックスタート

デプロイは**6つのPhase**に分けて進めます：

1. **Phase 0: デプロイ前の準備**
   - セキュリティチェック（`.gitignore`で機密情報を除外）
   - GitHubにPush
   - サーバーとデータベースの準備確認

2. **Phase 1: サーバーへの接続**
   - IPアドレス確認 → セキュリティグループ更新 → SSH接続

3. **Phase 2: コードの取得と準備**
   - `git pull origin main` → ファイル権限の確認

4. **Phase 3: Dockerイメージのビルド**
   - ディスク容量確認 → `docker build -t unhandy-for-happiness:latest .`

5. **Phase 4: コンテナの起動**
   - 既存コンテナ削除 → `docker run -d --name unhandy-for-happiness --network host ...`

6. **Phase 5: 動作確認**
   - コンテナ状態確認 → ログ確認 → ブラウザでアクセス

**詳細な手順とチェックリスト**: [`docs/private/DEPLOYMENT_NOTES.md`](docs/private/DEPLOYMENT_NOTES.md) を参照してください。

---

### トラブルシューティング（5段階フロー）

問題が発生した場合、以下の順序で確認：

1. **Level 1: 接続確認** - EC2状態、セキュリティグループ、SSH
2. **Level 2: Docker確認** - コンテナ状態、ログ
3. **Level 3: アプリケーション確認** - 環境変数、ファイル権限
4. **Level 4: データベース確認** - MySQL起動、認証方式、権限
5. **Level 5: ネットワーク確認** - ポート開放、`--network host`設定

**詳細な対処法**: [`docs/private/DEPLOYMENT_NOTES.md`](docs/private/DEPLOYMENT_NOTES.md) を参照してください。

---

### デプロイワークフロー

環境の不整合を防ぐため、以下のワークフローを徹底：

```
ローカル修正 → 動作確認 → GitHub Push → EC2接続 → 
git pull → Docker再ビルド → コンテナ起動 → 動作確認
```

**重要**: 本番環境で直接コードを編集せず、必ずGit経由でデプロイする

---

### 初回セットアップ

初めてデプロイする場合の手順：

1. **EC2とソフトウェアの準備**（Ubuntu 24.04 LTS、Docker、MySQL）
2. **データベースとユーザーの作成**（`mysql_native_password`認証）
3. **SECRET_KEY_BASEの生成**（`docker run --rm ... bin/rails secret`）
4. **コンテナ起動**（`--network host`でホスト側のMySQLに接続）

**詳細**: [`docs/private/DEPLOYMENT_NOTES.md`](docs/private/DEPLOYMENT_NOTES.md) の「従来のデプロイ手順」を参照

---

## 🔧 運用方法

### よくある運用タスク

| タスク | 手順 |
|--------|------|
| **EC2再起動** | AWSコンソールから起動 → 自動的にアプリも起動（`--restart always`設定済み） |
| **コンテナ再起動** | `docker restart unhandy-for-happiness` |
| **コード更新** | `git pull` → `docker build` → `docker rm -f` → `docker run` |
| **Wi-Fi変更時** | アプリアクセスは影響なし / SSH接続時はセキュリティグループを更新 |

**詳細な手順**: [`docs/private/DEPLOYMENT_NOTES.md`](docs/private/DEPLOYMENT_NOTES.md) の「運用方法」を参照

---

## 🔍 トラブルシューティング

### よくあるエラーと対処法

| エラー | 主な原因 | 対処法 |
|--------|---------|--------|
| **接続が拒否される** | EC2停止、コンテナ停止、ポート未開放 | インスタンス・コンテナ確認、セキュリティグループ確認 |
| **SSH timeout** | IPアドレス変更 | `curl ifconfig.me` → セキュリティグループ更新 |
| **MySQL接続エラー** | 認証方式不一致、権限不足 | `mysql_native_password`確認、権限再設定 |
| **SECRET_KEY_BASE不足** | 環境変数未設定 | `bin/rails secret`で生成 → `-e`で渡す |
| **実行権限エラー** | スクリプトに実行権限なし | `chmod +x bin/docker-entrypoint` → 再ビルド |

### 体系的なトラブルシューティング

問題発生時は**5段階フロー**で確認：

1. **Level 1**: 接続（EC2、SSH、セキュリティグループ）
2. **Level 2**: Docker（コンテナ状態、ログ）
3. **Level 3**: アプリ（環境変数、権限）
4. **Level 4**: DB（MySQL起動、認証、権限）
5. **Level 5**: ネットワーク（ポート、ファイアウォール）

**詳細な対処法とコマンド**: [`docs/private/DEPLOYMENT_NOTES.md`](docs/private/DEPLOYMENT_NOTES.md) を参照

---

## 📞 お問い合わせ

プロジェクトに関するご質問やフィードバックは、GitHubのIssueでお願いします。

---

## 📄 ライセンス

このプロジェクトはMITライセンスのもとで公開されています。

---

## 👤 作成者

**服部康太**
- GitHub: [@reskillfrom31-lab](https://github.com/reskillfrom31-lab) 
- Email: re.skill.from31@gmail.com 

---

**最終更新日:** 2026年1月13日  
**デプロイ実績:** 3回（2025年12月19日、12月28日、2026年1月13日）
